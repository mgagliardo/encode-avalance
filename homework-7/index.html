<!DOCTYPE html>
<html lang="en">
<head>
    <title>Avalanche Encode Homework #7</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <script src="https://unpkg.com/ipfs-api@26.1.2/dist/index.js"
        crossorigin="anonymous"></script>
</head>
<script type="text/javascript">
    function upload() {
        const reader = new FileReader();
        reader.onloadend = function () {
            const ipfs = window.IpfsApi('ipfs.infura.io', '5001', {protocol: 'https'}); // Connect to IPFS
            const buf = ipfs.types.Buffer(reader.result) // Convert data into buffer
            ipfs.files.add(buf, (err, result) => { // Upload buffer to IPFS
                if (err) {
                    console.error(err)
                    return
                }
                let url = `https://ipfs.io/ipfs/${result[0].hash}`
                console.log(`Url --> ${url}`)
                document.getElementById("url").innerHTML = url
                document.getElementById("url").href = url
                document.getElementById("output").src = url
            })
        }
        const file = document.getElementById("file");
        reader.readAsArrayBuffer(file.files[0]); // Read Provided File
    }
</script>

<script type="text/javascript">
    function read() {
        (async () => {
            const ipfs = window.IpfsApi('ipfs.infura.io', '5001', { protocol: 'https' }); // Connect to IPFS
            const data = ipfs.types.Buffer.concat(await all(ipfs.cat(cid)));

            // Print data to console 
            console.log(data.toString());
        })();



        const reader = new FileReader();
        reader.onloadend = function () {
            const ipfs = window.IpfsApi('ipfs.infura.io', '5001', { protocol: 'https' }); // Connect to IPFS
            const buf = ipfs.types.Buffer(reader.result) // Convert data into buffer
            ipfs.files.add(buf, (err, result) => { // Upload buffer to IPFS
                if (err) {
                    console.error(err)
                    return
                }
                let url = `https://ipfs.io/ipfs/${result[0].hash}`
                console.log(`Url --> ${url}`)
                document.getElementById("url").innerHTML = url
                document.getElementById("url").href = url
                document.getElementById("output").src = url
            })
        }
        const file = document.getElementById("file");
        reader.readAsArrayBuffer(file.files[0]); // Read Provided File
    }
</script>

<body>
    <form action="/">
        <fieldset>
            <legend>Upload a file</legend>
            <input type="file" name="file" id="file">
            <button type="button" onclick="upload()">Upload</button>
        </fieldset>
        <fieldset>
            <legend>Read from IPFS</legend>
            <label for="uname">Insert your IPFS CID Here: </label>
            <input type="text" id="uname" name="name" placeholder="A full IPFS CID">
            <button type="button" onclick="read()">Send</button>
        </fieldset>
    </form>
    </br>
    </br>
        <a id="url"></a>
    </br>
    </br>
</body>

</html>
